name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0
          
      - name: Package Chart and Create Release
        run: |
          # Package the chart
          helm package helm-chart
          
          # Get the chart name and version
          CHART_NAME=$(helm show chart helm-chart | grep '^name:' | cut -d' ' -f2)
          CHART_VERSION=$(helm show chart helm-chart | grep '^version:' | cut -d' ' -f2)
          PACKAGE_NAME="${CHART_NAME}-${CHART_VERSION}.tgz"
          
          echo "Chart: $CHART_NAME"
          echo "Version: $CHART_VERSION"
          echo "Package: $PACKAGE_NAME"
          
          # Create GitHub release
          gh release create "v${CHART_VERSION}" "$PACKAGE_NAME" \
            --title "Release v${CHART_VERSION}" \
            --notes "Helm chart release v${CHART_VERSION}"
            
          # Clone to gh-pages branch and update
          git checkout --orphan gh-pages
          git rm -rf .
          
          # Copy the package and create index
          cp "$PACKAGE_NAME" .
          helm repo index . --url "https://ninjatec.github.io/helmchecker/"
          
          # Commit and push
          git add .
          git commit -m "Release $PACKAGE_NAME"
          git push origin gh-pages --force
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}